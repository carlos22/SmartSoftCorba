//--------------------------------------------------------------------------
// Code generated by the SmartSoft MDSD Toolchain Version 0.2.1
// The SmartSoft Toolchain has been developed by:
//  
// ZAFH Servicerobotic Ulm
// Christian Schlegel (schlegel@hs-ulm.de)
// University of Applied Sciences
// Prittwitzstr. 10
// 89075 Ulm (Germany)
//
// Information about the SmartSoft MDSD Toolchain is available at:
// http://smart-robotics.sourceforge.net/
// 
// Please do not modify this file. It will be re-generated
// running the workflow.
//--------------------------------------------------------------------------

#include "MobileManipulationServer.hh"

// constructor
MobileManipulationServer::MobileManipulationServer()
{
	std::cout << "constructor MobileManipulationServer\n";

	ini.scanEnvironment.serviceName = "scanEnvironment";
	ini.getNewPoint.serviceName = "getNewPoint";
	ini.moveToPoint.serviceName = "moveToPoint";
	ini.manipulateObject.serviceName = "manipulateObject";
	ini.general.laserPort = "ttyACM0";
	ini.general.objectDatabase
			= "./src/components/MobileManipulationServer/src/data/objects.xml";
	ini.general.tempData
			= "./src/components/MobileManipulationServer/src/data/";
	ini.general.katanaComPortNr = 9;
	ini.general.katanaConfig
			= "./src/components/MobileManipulationServer/src/config/katana6M180.cfg";
}

void MobileManipulationServer::init(int argc, char *argv[])
{
	try
	{
		component = new CHS::SmartComponent("MobileManipulationServer", argc,
				argv);
		loadParameter(argc, argv);

		// create ports

		scanEnvironment = new CHS::QueryServer<Smart::CommMoMaScanEnvironment,
				Smart::CommMoMaObjectList>(component,
				ini.scanEnvironment.serviceName, objectRecognition);

		getNewPoint = new CHS::QueryServer<Smart::CommMoMaPose,
				Smart::CommMoMaPose>(component, ini.getNewPoint.serviceName,
				handleGetNewPoint);

		moveToPoint = new CHS::SendServer<Smart::CommMoMaPose>(component,
				ini.moveToPoint.serviceName, handleMoveToPoint);

		manipulateObject = new CHS::QueryServer<Smart::CommMoMaObjectList,
				Smart::CommMoMaManipulateState>(component,
				ini.manipulateObject.serviceName, openRave);

	} catch (const CORBA::Exception &)
	{
		std::cerr << "Uncaught CORBA exception" << std::endl;
	} catch (...)
	{
		std::cerr << "Uncaught exception" << std::endl;
	}
}

// run the component
void MobileManipulationServer::run()
{
	compHandler.onStartup();
	component->run();
	delete component;
}

void MobileManipulationServer::loadParameter(int argc, char *argv[])
{
	CHS::SmartParameter parameter;

	// load parameters
	try
	{
		// check if paramfile is given as argument
		bool paramFile = false;
		std::string str;
		for (int i = 0; i < argc; i++)
		{
			str = argv[i];
			if (str.find("filename") != std::string::npos)
				paramFile = true;
		}

		// if paramfile is given as argument
		if (paramFile == true)
		{
			std::cout << "load parameter file from argv \n";
			parameter.addFile(argc, argv, "filename", false);
		}
		// else load standard paramfile
		else
		{
			std::cout << "load MobileManipulationServer.ini parameter file\n";
			parameter.addFile("MobileManipulationServer.ini");
		}

		// than add command line arguments to allow overwriting of parameters
		// from file
		parameter.addCommandLine("", argc, argv);

		// print all known parameters
		parameter.print(); // TODO remove this


		// load parameter
		parameter.getString("scanEnvironment", "serviceName",
				ini.scanEnvironment.serviceName);
		parameter.getString("getNewPoint", "serviceName",
				ini.getNewPoint.serviceName);
		parameter.getString("moveToPoint", "serviceName",
				ini.moveToPoint.serviceName);
		parameter.getString("manipulateObject", "serviceName",
				ini.manipulateObject.serviceName);
		parameter.getString("general", "laserPort", ini.general.laserPort);
		parameter.getString("general", "objectDatabase",
				ini.general.objectDatabase);
		parameter.getString("general", "tempData", ini.general.tempData);
		parameter.getInt("general", "katanaComPortNr",
				ini.general.katanaComPortNr);
		parameter.getString("general", "katanaConfig", ini.general.katanaConfig);

	} catch (const CORBA::Exception &)
	{
		std::cerr << "Uncaught CORBA exception" << std::endl;
	} catch (const CHS::ParameterError & e)
	{
		std::cerr << "Exception from parameter handling: " << e << std::endl;
	} catch (...)
	{
		std::cerr << "Uncaught exception" << std::endl;
	}
}

